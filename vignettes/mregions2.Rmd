---
title: "Introduction to mregions2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mregions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mregions2)
library(magrittr) # use the pipe operator
```

mregions2 allows to access the [Marine Regions Gazetteer](https://marineregions.org/gazetteer.php) and the [Marine Regions Data Products](https://marineregions.org/sources.php) in R.

# What's Marine Regions?

[Marine Regions](https://marineregions.org/) is part of the [LifeWatch project](https://www.lifewatch.be/). Its activities focus on two main outputs: The [Marine Regions Gazetteer](https://marineregions.org/gazetteer.php) and the [Marine Regions Data Products](https://marineregions.org/sources.php).

The [Marine Regions Gazetteer](https://marineregions.org/gazetteer.php) is a standard list of marine georeferenced place names.

> Gazetteer: a dictionary of geographical names. 

<sup>https://www.thefreedictionary.com/gazetteer</sup>

All geographic objects of the Marine Regions Gazetteer database have a unique ID, named the [**MRGID**](https://marineregions.org/mrgid.php)

> Syntax `http://marineregions.org/mrgid/<number>`

<sup>E.g. https://marineregions.org/mrgid/3293</sup>

In addition to the Marine Regions Gazetteer, the Marine Regions Team creates and hosts geographical Data Products, being the most popular one the [Marine Regions Maritime Boundaries](https://marineregions.org/eez.php).


![140389_marineregions-v11---eez](https://user-images.githubusercontent.com/54405067/156809171-1487bb9f-35af-4418-8e2f-93c24a59aad0.gif)

<sup>(Source: https://www.vliz.be/en/news?p=show&id=8160)</sup>

# What's mregions2?

mregions2 aims to retrieve marine geospatial information from the [Marine Regions Gazetteer](https://marineregions.org/gazetteer.php?p=webservices) and access the  [Marine Regions Data Products](https://marineregions.org/sources.php).

The mregions2 package makes this difference clear from the naming of its functions:
* Gazetteer functions: `gaz_*()`
* Data Products functions: `mrp_()*`

These differences are not trivial as mregions2 uses different methods to access the Marine Regions Gazetteer than the Marine Regions Data Products: the Marine Regions Gazetteer is accessible using [RESTful methods](https://www.marineregions.org/gazetteer.php?p=webservices) with [gaz_search()]. The Marine Regions Data Products can be accessed using [OGC Web Services](https://www.marineregions.org/webservices.php). They are hosted at the [Flanders Marine Institute (VLIZ) geoserver](https://geo.vliz.be): 

> `http://geo.vliz.be/`

They can be visualized via [Web Map Services (WMS)](https://en.wikipedia.org/wiki/Web_Map_Service) with [mrp_view()] or downloaded by [Web Feature Services (WFS)](https://en.wikipedia.org/wiki/Web_Feature_Service) with [mrp_get()]

# Why mregions2 instead of mregions?
mregions2 supersedes {`mregions`}. The need of mregions2 is further explained in `vignette("why_mregions2")`


>**NOTE**
>
> The naming `mrp_*()` instead of `mr_()` was decided to avoid overlapping with the functions from {`mregions`}

# Marine Regions Gazetteer

## Search

### Search by free text

You can look up for marine places the Marine Regions Gazetteer with a free text search.

```{r gaz1}
# Any term with the word 'Belgian'
gaz_search("Belgian")

# Search names in different languages (provide ISO 2c code)
gaz_search("Belgie", language = "nl")

# Restrict your search
gaz_search("Belgium", like = FALSE, fuzzy = FALSE)

```


### Search by MRGID

The entries in the Marine Regions Gazetteer are identified with an unique and persistent identifier: the Marine Regions Global Identifier or MRGID. The concept of MRGID is further explained in `vignette("mregions2")`.

You can pass this identifier to [gaz_search()] to get only that record. E.g. in the previous example, the Belgian Exclusive Economic Zone has the MRGID `3293`:

```{r gaz2}
gaz_search(3293)
```

You can get the gazetteer entry as Open Linked Data, in the form of an object of class `rdflib::rdf`:

```{r gaz2}
gaz_search(3293, rdf = TRUE)
```

Learn more about using the mregions2 to access the Marine Regions Gazetteer as RDF in `vignette("mregions2-rdf")`


### Search by longitude and latitude

You can do a reverse geocode with mregions2: passing a pair longitude-latitude coordinates in the WGS84 projection will return all records that intersect with the point.

e.g. the pair [longitude 2.927 - latitude 51.21551](https://www.openstreetmap.org/search?query=51.21551%252C%202.927) lays on the city of [Ostend](https://wikipedia.org/wiki/Ostend) at the Belgian coast 

```{r gaz6}
gaz_search(x = 2.927, y = 51.21551)
```

Passing an `sf::sfg` geometry object is also allowed:

```{r gaz7}
pt <- st_point(c(x = 2.927, y = 51.21551))
pt

gaz_search(pt)
```


### Search by place type

The records of the Marine Regions Gazetteer have a place types assigned, either physical such as sea mounts or banks, or administrative like Territorial Sea or Exclusive Economic Zone.

You can find the full list, descriptions and its identifier in the database with [gaz_types()]:

```{r gaz8}
gaz_types()
```

You can restrict your search to a certain typeid:

```{r gaz9}
gaz_search("Oostende", typeid = 1)
```

Or you can look up all the records with a certain place type.
```{r gaz10}
# With text
gaz_search_by_type("Town")

# With the place type ID
gaz_search_by_type(1)
```


### Search by source document

The entries in the Marine Regions Gazetteer are always based on a source. This is either a document, a web site or any sort of authority. 

The list of sources is available with [gaz_sources()]

```{r gaz11}
# List sources
gaz_sources()

# With text
gaz_search_by_source("Flanders Marine Institute (VLIZ)")

# With source ID
gaz_search_by_source(695) 
```


## Geometries

### Add the geometries

The entries of the Marine Regions Gazetteer have geometry associated. To avoid overloading the server, these are not returned by default. You can pass the result of [gaz_search()] to [gaz_geometry()] to also get the geometry of the record. It will return an object of class `sf::sf`. 

```{r gaz3}
gaz_search(3293) %>% gaz_geometry()
```

You can also use the argument `with_geometry` as `gaz_search(3293, with_geometry = TRUE)` to load the geometry directly.


### Get only the geometries

Geometries can be also retrieved by providing an MRGID. By default, this is a simple feature geometry list column, an object of class `sf::sfc`

```{r gaz4}
gaz_geometry(3293)
```

But other formats are possible:

```{r gaz5}
# As Well-Known Text (WKT)
gaz_geometry(3293, format = "wkt")

# As RDF
gaz_geometry(3293, format = "rdf")

# As sf
gaz_geometry(3293, format = "sf")

```

Learn more about using the mregions2 to access the Marine Regions Gazetteer as RDF in `vignette("mregions2-rdf")`


## Relations

The Marine Regions Gazetteer is hierarchical: This means that all the records got relations with each other. You can either pass the result of [gaz_search()] to [gaz_relations()] or an MRGID:

```{r gaz12, eval = FALSE}
# With gaz_search()
gaz_search(3293) %>% gaz_relations()

# With MRGID
gaz_relations(3293)
```

The relations must be one of `c("partof", "partlypartof", "adjacentto", "similarto", "administrativepartof", "influencedby")` or `"all"` to get all related records (default). You can also decide if you want records that are upper or lower on the hierarchy of the records, or both (default)

```{r gaz13}
gaz_relations(3293, direction = "upper", type = "partof")
```

## RESTful services

mregions2 can access the Marine Regions Gazetteer by using RESTful web services. There is a set of functions in mregions2 named as `gaz_rest_*()` that read the web services via [HTTP](https://httr2.r-lib.org/). These are closer to the definition of the web services. All the gazetteer functions shown before make use of this set of functions. 

| Main functions         | REST function                  | REST web service             |
|------------------------|--------------------------------|------------------------------|
| gaz_search()           | gaz_rest_records_by_name()     | getGazetteerRecordsByName    |
| gaz_search()           | gaz_rest_records_by_names()    | getGazetteerRecordsByNames   |
| gaz_search()           | gaz_rest_record_by_mrgid()     | getGazetteerRecordByMRGID    |
| gaz_search()           | gaz_rest_records_by_lat_long() | getGazetteerRecordsByLatLong |
| gaz_search_by_type()   | gaz_rest_records_by_type()     | getGazetteerRecordsByType    |
| gaz_search_by_source() | gaz_rest_records_by_source()   | getGazetteerRecordsBySource  |
| gaz_search_by_source() | gaz_rest_source_by_sourceid()  | getGazetteerSourceBySourceID |
| gaz_types()            | gaz_rest_types()               | getGazetteerTypes            |
| gaz_sources()          | gaz_rest_sources()             | getGazetteerSources          |
| gaz_geometry()         | gaz_rest_geometries()          | getGazetteerGeometries       |
| NA                     | gaz_rest_names_by_mrgid()      | getGazetteerNamesByMRGID     |
| NA                     | gaz_rest_wmses()               | getGazetteerWMSes            |
| NA                     | NA                             | getFeed                      |


## Marine Regions Gazetteer as RDF - Open Linked Data 

You can read the Marine Regions Gazetteer as Open Linked Data. 

```{r gaz_rdf}
gaz_search(3293, rdf = TRUE)

gaz_geometry(3293, format = "rdf")
```

See `vignette("mregions-rdf")` for more information.

# Marine Regions Data Products

The main function to load a Marine Regions Data Product into R is [mrp_get()]. To select a data product, you have to pass the `product_name` of one

```{r prod1}
# See the full list of data products
mrp_list()

# Get the Extended Continental Shelves
mrp_get("ecs")
```

However, this is a request that may take some time to complete. An interactive visualization without the need to download can be rendered with [mrp_view()]:

```{r prod2}
# Click on a feature to see some information
mrp_view("ecs")
```

This returns a Leaflet interactive map with the data product requested added via Web Map Services.


## Filtering

In some cases, you may be interested in retrieving only a certain amount of records. Or filter out some features. You could download the product with [mrp_get()] and then apply a filter with R base or with the tidyverse. But getting the data is an expensive operation that takes long. 

```{r prod3}
system.time({
  ecs <- mrp_get("ecs") %>% filter(sovereign1 = "Portugal")
})

```

Instead, you can write a filter that is applied on the server side:

```{r prod4}
system.time({
  ecs <- mrp_get("ecs", cql_filter = "sovereign1 = 'Portugal'")
})

```


This type of filter is written in [Contextual Query Language (CQL)](https://portal.ogc.org/files/96288). This is a relatively simple syntax close to SQL. 

### Colnames and unique values

Writting these filters can be challenging without knowing in advance the names of the columns in a data product, or the unique values that these columns have. If you have to retrieve the full product to get to know the columns and their values then well, the filter misses a bit its point.

mregions2 has two helpers that help on this mission: [mrp_colnames()] gets you a data frame with the columns and data type of a data product. [mrp_col_unique()] (or [mrp_col_distinct()], they are the same function) return the unique values of a column in a data product.

```{r prod7}
# Columns of the Extended Continental Shelves data product
mrp_colnames("ecs")

# Unique values of the column pol_type
mrp_col_unique("ecs", "pol_type")

# Get all the Overlapping claims
mrp_get("ecs", cql_filter = "pol_type = 'ECS Overlapping claim'")
```


### OGC, CQL and ECQL Filters

You can also apply a [standard OGC filter specification](https://www.ogc.org/standards/filter). These are however more verbose:

```{r prod4}
mrp_get("ecs", filter = "<Filter><PropertyIsEqualTo><PropertyName>sovereign1</PropertyName><Literal>Portugal</Literal></PropertyIsEqualTo></Filter>")
```

There are many types of filter allowed via standard OGC or CQL filters. [mrp_get()] and [mrp_view()] use OGC [WFS](https://en.wikipedia.org/wiki/Web_Feature_Service) and [WMS](https://en.wikipedia.org/wiki/Web_Map_Service) respectively. On the R side, [mrp_get()] uses the package [ows4R], and any vendor parameters can be passed to the method `getFeatures()` as e.g. `count` (WFS version 2.0.0). 

```{r prod5}
# Get only one feature
mrp_get("ecs", count = 1)
```

[mrp_view()] uses [leaflet.extras2::addWMS()], which [enables passing the filters together with the base URL](https://github.com/trafficonese/leaflet.extras2/issues/42) in the argument `baseURL`.

```{r prod6}
# View all Joint submissions, recommendations of deposit to DOALOS with an area larger than 1M square kilometers
mrp_view("ecs", cql_filter = "pol_type IN ('ECS Joint CLCS Recommendation', 'ECS Joint CLCS Submission', 'ECS Joint DOALOS Deposit') AND area_km2 > 1000000")
```

Note that all the data products of Marine Regions are served via the [VLIZ geoserver](http://geo.vliz.be). Geoserver implements a more powerful extension of CQL called ECQL (Extended CQL). which allows expressing the full range of filters that OGC Filter 1.1 can encode. ECQL is accepted in many places in GeoServer.

Whenever the documentation refers to CQL, ECQL syntax can be used as well.

I recommend [the CQL/ECQL filtering vignette](https://emodnet.github.io/EMODnetWFS/articles/ecql_filtering.html) in the [EMODnetWFS] R package about  to know more. The principles explained there are useful also for mregions2.


